'use client';
import { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  'https://iypezirwdlqpptjpeeyf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5cGV6aXJ3ZGxxcHB0anBlZXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Nzg3NzYsImV4cCI6MjA4NDI1NDc3Nn0.rfTN8fi9rd6o5rX-scAg9I1BbC-UjM8WoWEXDbrYJD4'
);

const COMPANIES = ['A-C Electric','AKE-Line','Apache Corp.','Armstrong Oil & Gas','ASRC Energy Services','CCI-Industrial','Chosen Construction','CINGSA','Coho Enterprises','Conam Construction','ConocoPhillips','Five Star Oilfield Services','Fox Energy Services','G.A. West','GBR Equipment','GLM Energy Services','Graham Industrial Coatings','Harvest Midstream','Hilcorp Alaska','MagTec Alaska','Merkes Builders','Nordic-Calista','Parker TRS','Peninsula Paving','Pollard Wireline','Ridgeline Oilfield Services','Santos','Summit Excavation','Tesoro Refinery','Yellowjacket','Other'];
const LOCATIONS = ['Kenai','CIO','Beaver Creek','Swanson River','Ninilchik','Nikiski','Other Kenai Asset','Deadhorse','Prudhoe Bay','Kuparuk','Alpine','Willow','ENI','PIKKA','Point Thompson','North Star Island','Endicott','Badami','Other North Slope'];
const ENERGY_TYPES = [{value:'Gravity',icon:'‚¨áÔ∏è',desc:'Falls, drops'},{value:'Motion',icon:'üöó',desc:'Vehicles'},{value:'Mechanical',icon:'‚öôÔ∏è',desc:'Pinch points'},{value:'Electrical',icon:'‚ö°',desc:'Shock'},{value:'Pressure',icon:'üí®',desc:'Hydraulic'},{value:'Chemical',icon:'‚ò†Ô∏è',desc:'Toxic'},{value:'Temperature',icon:'üî•',desc:'Burns'},{value:'Stored',icon:'üîã',desc:'Springs'}];
const CONTROL_TYPES = [{value:'Elimination',icon:'üö´'},{value:'Substitution',icon:'üîÑ'},{value:'Engineering',icon:'üîß'},{value:'Guarding',icon:'üöß'},{value:'LOTO',icon:'üîí'},{value:'Warnings',icon:'‚ö†Ô∏è'},{value:'Procedures',icon:'üìã'},{value:'PPE',icon:'ü¶∫'}];
const GENERAL_ITEMS = ['Emergency Response Plan','Communication Plan','Work Area Inspected','Tools Inspected','Weather Checked','SIMOPS Reviewed'];
const PPE_REQUIREMENTS = ['Hard Hat','Safety Glasses','Steel Toe Boots','Gloves','FRC/Nomex','Hearing Protection','Fall Protection','Respiratory','Face Shield','H2S Monitor'];
const PERMITS_REQUIRED = ['Hot Work','Confined Space','LOTO','Excavation','Opening/Blinding','Unit Work','Electrical','General Work'];
const POTENTIAL_HAZARDS = ['Pinch Points','Electrical','Pressurized Systems','Chemical Exposure','H2S','Fall Hazards','Struck By','Caught In/Between','Noise','Temperature Extremes','Lifting/Ergonomic','Slips/Trips/Falls'];
const AWARENESS_WORDS = ['awareness','aware','be careful','watch out','pay attention','be alert','stay alert','look out','be cautious','use caution','be mindful'];
const GOOD_CONTROL_WORDS = ['barricade','guardrail','lock','tag','isolate','ppe','gloves','hard hat','safety glasses','harness','spotter','verify','inspect','check','secure','communicate','radio','confirm','test','monitor'];
const gradeColors = {A:'#22c55e',B:'#84cc16',C:'#facc15',D:'#f97316',F:'#dc2626'};

function analyzeQuality(taskSteps) {
  const results = {overallScore:0,overallGrade:'F',stepAnalyses:[],summary:{awarenessOnlyCount:0,goodControlsCount:0,stepsWithHazards:0,stepsWithMitigations:0,totalSteps:taskSteps.length},feedback:[],strengths:[],improvements:[]};
  if (!taskSteps||taskSteps.length===0){results.feedback.push('No task steps.');return results;}
  let totalScore=0;
  taskSteps.forEach((step,i)=>{
    let stepScore=75;const stepFeedback=[];let hasAwareness=false,hasGoodControls=false;
    if(!step.task?.trim()){stepScore-=10;stepFeedback.push('Add task');}
    else if(step.task.split(/\s+/).length>=8){stepScore+=5;stepFeedback.push('‚úì Good detail');}
    if(!step.hazards?.trim()){stepScore-=8;stepFeedback.push('Add hazards');}
    else{results.summary.stepsWithHazards++;if(step.hazards.split(/\s+/).length>=5){stepScore+=5;}}
    if(!step.actions?.trim()){stepScore-=8;stepFeedback.push('Add controls');}
    else{
      results.summary.stepsWithMitigations++;const actionLower=step.actions.toLowerCase();
      let goodCount=0;GOOD_CONTROL_WORDS.forEach(w=>{if(actionLower.includes(w))goodCount++;});
      if(goodCount>=2){stepScore+=10;hasGoodControls=true;results.summary.goodControlsCount++;stepFeedback.push('‚úÖ Good controls!');}
      else if(goodCount>=1){stepScore+=5;hasGoodControls=true;results.summary.goodControlsCount++;}
      AWARENESS_WORDS.forEach(w=>{if(actionLower.includes(w))hasAwareness=true;});
      if(hasAwareness&&!hasGoodControls){results.summary.awarenessOnlyCount++;stepScore-=5;stepFeedback.push('üí° Add physical controls');}
    }
    stepScore=Math.max(50,Math.min(100,stepScore));totalScore+=stepScore;
    results.stepAnalyses.push({stepNumber:i+1,stepScore,feedback:stepFeedback,awarenessOnly:hasAwareness&&!hasGoodControls,hasGoodControls});
  });
  let avgScore=totalScore/taskSteps.length,bonus=0;
  if(taskSteps.length>=5)bonus+=5;else if(taskSteps.length>=3)bonus+=3;
  if(results.summary.stepsWithHazards>=taskSteps.length*0.7)bonus+=5;
  if(results.summary.goodControlsCount>=2)bonus+=5;
  let deduction=results.summary.awarenessOnlyCount>0?Math.min(results.summary.awarenessOnlyCount*2,8):0;
  results.overallScore=Math.round(Math.max(50,Math.min(100,avgScore+bonus-deduction)));
  results.overallGrade=results.overallScore>=90?'A':results.overallScore>=80?'B':results.overallScore>=70?'C':results.overallScore>=60?'D':'F';
  if(results.overallScore>=90){results.feedback.push('‚úÖ EXCELLENT THA!');results.strengths.push('Thorough hazard identification','Strong physical controls');}
  else if(results.overallScore>=80){results.feedback.push('‚úì GOOD THA!');results.strengths.push('Good hazard awareness');}
  else if(results.overallScore>=70)results.feedback.push('‚úì DECENT THA');
  else results.feedback.push('‚ö†Ô∏è Add more detail');
  if(results.summary.awarenessOnlyCount>0)results.improvements.push('üí° '+results.summary.awarenessOnlyCount+' step(s) need physical controls');
  if(taskSteps.length<3)results.improvements.push('üí° Add more steps (3-5+)');
  return results;
}

function generateTHANumber(){const now=new Date();const d=now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0');return 'THA-'+d+'-'+String(Math.floor(Math.random()*10000)).padStart(4,'0');}

export default function THAForm(){
  const [activeTab,setActiveTab]=useState('new');
  const [isSubmitting,setIsSubmitting]=useState(false);
  const [submitted,setSubmitted]=useState(false);
  const [submittedTHA,setSubmittedTHA]=useState(null);
  const [qualityCheckPassed,setQualityCheckPassed]=useState(false);
  const [qualityResults,setQualityResults]=useState(null);
  const [showQualityPanel,setShowQualityPanel]=useState(false);
  const [crewUnlocked,setCrewUnlocked]=useState(false);
  const [openTHAs,setOpenTHAs]=useState([]);
  const [loadingOpenTHAs,setLoadingOpenTHAs]=useState(false);
  const [selectedTHA,setSelectedTHA]=useState(null);
  const [thaDetails,setThaDetails]=useState(null);
  const [formData,setFormData]=useState({date:new Date().toISOString().split('T')[0],company:'',location:'',work_area:'',crew_lead:'',phone_radio:'',task_description:'',job_planning_notes:'',procedure_exists:'',procedure_reviewed:'',driving_backing:false,walkaround_360:false,seatbelts_checked:false,spotter_when_backing:false,load_secured:false,general_items:{},ppe_requirements:{},permits_required:{},potential_hazards:{},energy_types:[],control_types:[]});
  const [taskSteps,setTaskSteps]=useState([{task:'',hazards:'',actions:''},{task:'',hazards:'',actions:''},{task:'',hazards:'',actions:''}]);
  const [crewMembers,setCrewMembers]=useState([{name:'',company:'',comments:''}]);
  const [closeoutThaNumber,setCloseoutThaNumber]=useState('');
  const [closeoutData,setCloseoutData]=useState({scope_changed:'',tha_updated_if_changed:'',client_rep_visited:false,hse_visited:false,job_stopped:false,housekeeping_complete:false,all_permits_closed:false,info_passed_to_oncoming:false,aar_went_well:'',aar_didnt_go_as_planned:'',aar_how_improve:'',lessons_learned:'',crew_comments:'',closed_by:''});
  const [closeoutSuccess,setCloseoutSuccess]=useState(false);
  const [newTaskSteps,setNewTaskSteps]=useState([]);
  const [newCrewMembers,setNewCrewMembers]=useState([]);
  const [updateSuccess,setUpdateSuccess]=useState(false);

  useEffect(()=>{if(activeTab==='open'||activeTab==='closeout')loadOpenTHAs();},[activeTab]);

  const loadOpenTHAs=async()=>{setLoadingOpenTHAs(true);try{const{data,error}=await supabase.from('tha_assessments').select('*').eq('status','Open').order('created_at',{ascending:false});if(error)throw error;setOpenTHAs(data||[]);}catch(e){console.error(e);}finally{setLoadingOpenTHAs(false);}};

  const loadTHADetails=async(thaNumber)=>{try{
    const{data:tha}=await supabase.from('tha_assessments').select('*').eq('tha_number',thaNumber).single();
    const{data:steps}=await supabase.from('tha_task_steps').select('*').eq('tha_number',thaNumber).order('step_number');
    const{data:crew}=await supabase.from('tha_crew_signoff').select('*').eq('tha_number',thaNumber);
    setThaDetails({...tha,taskSteps:steps||[],crewMembers:crew||[]});setSelectedTHA(thaNumber);setNewTaskSteps([]);setNewCrewMembers([]);setUpdateSuccess(false);
  }catch(e){console.error(e);alert('Error: '+e.message);}};

  const handleChange=(e)=>{const{name,value,type,checked}=e.target;setFormData(p=>({...p,[name]:type==='checkbox'?checked:value}));};
  const handleCheckboxGroup=(group,value)=>{setFormData(p=>({...p,[group]:{...p[group],[value]:!p[group][value]}}));};
  const toggleEnergyType=(v)=>{setFormData(p=>({...p,energy_types:p.energy_types.includes(v)?p.energy_types.filter(x=>x!==v):[...p.energy_types,v]}));};
  const toggleControlType=(v)=>{setFormData(p=>({...p,control_types:p.control_types.includes(v)?p.control_types.filter(x=>x!==v):[...p.control_types,v]}));};
  const updateTaskStep=(i,f,v)=>{setTaskSteps(p=>{const u=[...p];u[i]={...u[i],[f]:v};return u;});};
  const addTaskStep=()=>{setTaskSteps(p=>[...p,{task:'',hazards:'',actions:''}]);};
  const removeTaskStep=(i)=>{if(taskSteps.length>1)setTaskSteps(p=>p.filter((_,x)=>x!==i));};
  const updateCrewMember=(i,f,v)=>{setCrewMembers(p=>{const u=[...p];u[i]={...u[i],[f]:v};return u;});};
  const addCrewMember=()=>{setCrewMembers(p=>[...p,{name:'',company:'',comments:''}]);};
  const removeCrewMember=(i)=>{setCrewMembers(p=>p.filter((_,x)=>x!==i));};

  const runQualityCheck=()=>{
    const filled=taskSteps.filter(s=>s.task||s.hazards||s.actions);
    if(filled.length===0){alert('Add at least one task step.');return;}
    const r=analyzeQuality(filled);setQualityResults(r);setShowQualityPanel(true);if(r.overallScore>=60)setQualityCheckPassed(true);
  };

  const handleSubmit=async(e)=>{e.preventDefault();if(!qualityCheckPassed){alert('Run quality check first.');return;}
    setIsSubmitting(true);try{
      const thaNumber=generateTHANumber();const filled=taskSteps.filter(s=>s.task||s.hazards||s.actions);const q=analyzeQuality(filled);
      await supabase.from('tha_assessments').insert([{tha_number:thaNumber,status:'Open',date:formData.date,company:formData.company,location:formData.location,work_area:formData.work_area,crew_lead:formData.crew_lead,phone_radio:formData.phone_radio,task_description:formData.task_description,job_planning_notes:formData.job_planning_notes,procedure_exists:formData.procedure_exists,procedure_reviewed:formData.procedure_reviewed,driving_backing:formData.driving_backing,walkaround_360:formData.walkaround_360?'Yes':'No',seatbelts_checked:formData.seatbelts_checked?'Yes':'No',spotter_when_backing:formData.spotter_when_backing?'Yes':'No',load_secured:formData.load_secured?'Yes':'No',general_items:formData.general_items,ppe_requirements:formData.ppe_requirements,permits_required:formData.permits_required,potential_hazards:formData.potential_hazards,energy_types:formData.energy_types.join(', '),control_types:formData.control_types.join(', '),quality_score:q.overallScore,quality_grade:q.overallGrade,quality_notes:q.feedback.join(' | '),good_controls_count:q.summary.goodControlsCount,awareness_only_count:q.summary.awarenessOnlyCount}]);
      const stepsData=filled.map((s,i)=>({tha_number:thaNumber,step_number:i+1,task_step:s.task,potential_hazards:s.hazards,recommended_actions:s.actions,step_score:q.stepAnalyses[i]?.stepScore||75,has_good_controls:q.stepAnalyses[i]?.hasGoodControls||false,has_awareness_only:q.stepAnalyses[i]?.awarenessOnly||false,feedback:(q.stepAnalyses[i]?.feedback||[]).join('; ')}));
      if(stepsData.length>0)await supabase.from('tha_task_steps').insert(stepsData);
      const crewData=crewMembers.filter(c=>c.name).map(c=>({tha_number:thaNumber,crew_member_name:c.name,company:c.company,comments:c.comments}));
      if(crewData.length>0)await supabase.from('tha_crew_signoff').insert(crewData);
      setSubmittedTHA({thaNumber,qualityGrade:q.overallGrade,qualityScore:q.overallScore,feedback:q.feedback.join(' ')});setSubmitted(true);
    }catch(e){console.error(e);alert('Error: '+e.message);}finally{setIsSubmitting(false);}
  };

  const saveUpdates=async()=>{if(!selectedTHA)return;
    const hasSteps=newTaskSteps.some(s=>s.task||s.hazards||s.actions);const hasCrew=newCrewMembers.some(c=>c.name);
    if(!hasSteps&&!hasCrew){alert('No new data.');return;}
    setIsSubmitting(true);try{
      const{data:existing}=await supabase.from('tha_task_steps').select('step_number').eq('tha_number',selectedTHA).order('step_number',{ascending:false}).limit(1);
      let maxStep=existing?.length>0?existing[0].step_number:0;
      if(hasSteps){const stepsData=newTaskSteps.filter(s=>s.task||s.hazards||s.actions).map((s,i)=>({tha_number:selectedTHA,step_number:maxStep+i+1,task_step:s.task,potential_hazards:s.hazards,recommended_actions:s.actions}));if(stepsData.length>0)await supabase.from('tha_task_steps').insert(stepsData);}
      if(hasCrew){const crewData=newCrewMembers.filter(c=>c.name).map(c=>({tha_number:selectedTHA,crew_member_name:c.name,company:c.company,comments:c.comments}));if(crewData.length>0)await supabase.from('tha_crew_signoff').insert(crewData);}
      await supabase.from('tha_assessments').update({last_modified:new Date().toISOString()}).eq('tha_number',selectedTHA);
      setUpdateSuccess(true);setTimeout(()=>loadTHADetails(selectedTHA),1500);
    }catch(e){console.error(e);alert('Error: '+e.message);}finally{setIsSubmitting(false);}
  };

  const submitCloseout=async()=>{if(!closeoutThaNumber){alert('Enter THA number');return;}if(!closeoutData.closed_by){alert('Enter your name');return;}
    setIsSubmitting(true);try{
      await supabase.from('tha_assessments').update({status:'Closed',scope_changed:closeoutData.scope_changed,tha_updated_if_changed:closeoutData.tha_updated_if_changed,client_rep_visited:closeoutData.client_rep_visited?'Yes':'No',hse_visited:closeoutData.hse_visited?'Yes':'No',job_stopped:closeoutData.job_stopped?'Yes':'No',housekeeping_complete:closeoutData.housekeeping_complete?'Yes':'No',all_permits_closed:closeoutData.all_permits_closed?'Yes':'No',info_passed_to_oncoming:closeoutData.info_passed_to_oncoming?'Yes':'No',aar_went_well:closeoutData.aar_went_well,aar_didnt_go_as_planned:closeoutData.aar_didnt_go_as_planned,aar_how_improve:closeoutData.aar_how_improve,lessons_learned:closeoutData.lessons_learned,crew_comments:closeoutData.crew_comments,closed_by:closeoutData.closed_by,closed_at:new Date().toISOString()}).eq('tha_number',closeoutThaNumber).eq('status','Open');
      setCloseoutSuccess(true);
    }catch(e){console.error(e);alert('Error: '+e.message);}finally{setIsSubmitting(false);}
  };

  const resetForm=()=>{setFormData({date:new Date().toISOString().split('T')[0],company:'',location:'',work_area:'',crew_lead:'',phone_radio:'',task_description:'',job_planning_notes:'',procedure_exists:'',procedure_reviewed:'',driving_backing:false,walkaround_360:false,seatbelts_checked:false,spotter_when_backing:false,load_secured:false,general_items:{},ppe_requirements:{},permits_required:{},potential_hazards:{},energy_types:[],control_types:[]});setTaskSteps([{task:'',hazards:'',actions:''},{task:'',hazards:'',actions:''},{task:'',hazards:'',actions:''}]);setCrewMembers([{name:'',company:'',comments:''}]);setSubmitted(false);setSubmittedTHA(null);setQualityCheckPassed(false);setQualityResults(null);setShowQualityPanel(false);setCrewUnlocked(false);};
  const resetCloseout=()=>{setCloseoutThaNumber('');setCloseoutData({scope_changed:'',tha_updated_if_changed:'',client_rep_visited:false,hse_visited:false,job_stopped:false,housekeeping_complete:false,all_permits_closed:false,info_passed_to_oncoming:false,aar_went_well:'',aar_didnt_go_as_planned:'',aar_how_improve:'',lessons_learned:'',crew_comments:'',closed_by:''});setCloseoutSuccess(false);loadOpenTHAs();};

  const s={container:{minHeight:'100vh',background:'linear-gradient(135deg, #1e3a8a 0%, #b91c1c 100%)',padding:'20px'},formContainer:{maxWidth:'1000px',margin:'0 auto',background:'white',borderRadius:'12px',boxShadow:'0 4px 6px rgba(0,0,0,0.1)',overflow:'hidden'},header:{background:'linear-gradient(135deg, #1e3a8a 0%, #b91c1c 100%)',color:'white',padding:'25px',textAlign:'center'},content:{padding:'25px'},tabs:{display:'flex',borderBottom:'2px solid #e5e7eb',marginBottom:'20px',flexWrap:'wrap'},tab:{padding:'12px 20px',cursor:'pointer',fontWeight:'500',borderBottom:'3px solid transparent',fontSize:'14px'},tabActive:{borderBottomColor:'#1e3a8a',color:'#1e3a8a'},sectionHeader:{color:'white',padding:'12px 20px',margin:'20px -25px 15px',fontWeight:'600',fontSize:'14px'},sectionBlue:{background:'linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%)'},sectionRed:{background:'linear-gradient(135deg, #b91c1c 0%, #991b1b 100%)'},sectionGreen:{background:'linear-gradient(135deg, #059669 0%, #047857 100%)'},sectionYellow:{background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'},sectionPurple:{background:'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)'},sectionCyan:{background:'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)'},formGroup:{marginBottom:'15px'},label:{display:'block',marginBottom:'5px',fontWeight:'500',fontSize:'13px'},input:{width:'100%',padding:'10px',border:'2px solid #d1d5db',borderRadius:'6px',fontSize:'15px',boxSizing:'border-box'},select:{width:'100%',padding:'10px',border:'2px solid #d1d5db',borderRadius:'6px',fontSize:'15px',background:'white',boxSizing:'border-box'},textarea:{width:'100%',padding:'10px',border:'2px solid #d1d5db',borderRadius:'6px',fontSize:'15px',minHeight:'70px',resize:'vertical',boxSizing:'border-box'},row:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'15px'},checkboxGrid:{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(180px, 1fr))',gap:'8px'},checkboxItem:{display:'flex',alignItems:'center',gap:'6px',padding:'8px',border:'1px solid #d1d5db',borderRadius:'6px',cursor:'pointer',fontSize:'12px'},checkboxItemSelected:{background:'#dbeafe',borderColor:'#1e3a8a'},radioGroup:{display:'flex',gap:'15px',flexWrap:'wrap'},radioOption:{display:'flex',alignItems:'center',gap:'6px',padding:'8px 12px',border:'2px solid #d1d5db',borderRadius:'6px',cursor:'pointer',fontSize:'13px'},radioOptionSelected:{borderColor:'#1e3a8a',background:'rgba(30,58,138,0.05)'},submitBtn:{width:'100%',padding:'14px',background:'linear-gradient(135deg, #1e3a8a 0%, #b91c1c 100%)',color:'white',border:'none',borderRadius:'8px',fontSize:'16px',fontWeight:'600',cursor:'pointer',marginTop:'15px'},analyzeBtn:{width:'100%',padding:'12px 24px',background:'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)',color:'white',border:'none',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer',marginTop:'15px'},infoBox:{background:'#eff6ff',border:'1px solid #bfdbfe',borderRadius:'6px',padding:'12px',marginBottom:'15px',fontSize:'12px',color:'#1e40af'},infoBoxWarning:{background:'#fef3c7',borderColor:'#fcd34d',color:'#92400e'},infoBoxSuccess:{background:'#ecfdf5',borderColor:'#6ee7b7',color:'#065f46'},qualityPanel:{background:'linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%)',borderRadius:'12px',padding:'20px',margin:'20px 0',color:'white'},bigGrade:{width:'80px',height:'80px',borderRadius:'50%',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',fontWeight:'bold'},taskTable:{width:'100%',borderCollapse:'collapse',margin:'15px 0'},taskTableTh:{background:'#1e3a8a',color:'white',padding:'10px 8px',textAlign:'left',fontSize:'12px'},taskTableTd:{padding:'8px',borderBottom:'1px solid #e5e7eb',verticalAlign:'top'},stepNum:{background:'#1e3a8a',color:'white',width:'30px',height:'30px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'bold',fontSize:'14px'},removeBtn:{background:'#dc2626',color:'white',border:'none',padding:'5px 10px',borderRadius:'4px',cursor:'pointer',fontSize:'12px'},addBtn:{background:'#059669',color:'white',border:'none',padding:'10px 20px',borderRadius:'6px',cursor:'pointer',fontWeight:'500',marginTop:'10px'},crewTable:{width:'100%',borderCollapse:'collapse',margin:'15px 0'},crewTableTh:{background:'#059669',color:'white',padding:'10px',textAlign:'left',fontSize:'12px'},successMessage:{background:'linear-gradient(135deg, #059669 0%, #047857 100%)',color:'white',padding:'30px',borderRadius:'12px',textAlign:'center',margin:'20px 0'},openThaCard:{border:'2px solid #d1d5db',borderRadius:'8px',marginBottom:'15px',overflow:'hidden',cursor:'pointer'},energySection:{background:'linear-gradient(135deg, #fef2f2 0%, #fff7ed 100%)',border:'2px solid #dc2626',borderRadius:'12px',padding:'20px',margin:'15px 0'},energyGrid:{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(200px, 1fr))',gap:'10px',marginBottom:'15px'},energyItem:{display:'flex',alignItems:'center',gap:'10px',padding:'12px',background:'white',border:'2px solid #e5e7eb',borderRadius:'8px',cursor:'pointer'},energyItemSelected:{borderColor:'#dc2626',background:'#fecaca'},controlGrid:{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(180px, 1fr))',gap:'8px'},controlItem:{display:'flex',alignItems:'center',gap:'8px',padding:'10px',background:'white',border:'2px solid #e5e7eb',borderRadius:'6px',cursor:'pointer',fontSize:'12px'},controlItemSelected:{borderColor:'#22c55e',background:'#d1fae5'},crewLocked:{opacity:0.5,pointerEvents:'none',position:'relative'},closeoutSection:{background:'#ecfdf5',border:'2px solid #059669',borderRadius:'8px',padding:'15px',margin:'15px 0'},aarSection:{background:'#eff6ff',border:'2px solid #3b82f6',borderRadius:'8px',padding:'15px',margin:'15px 0'},closeoutChecklist:{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(280px, 1fr))',gap:'10px',margin:'15px 0'},closeoutCheckItem:{display:'flex',alignItems:'center',gap:'10px',padding:'12px',border:'2px solid #d1d5db',borderRadius:'8px',cursor:'pointer'},closeoutCheckItemChecked:{borderColor:'#059669',background:'#ecfdf5'}};

  if(submitted&&submittedTHA){return(<div style={s.container}><div style={{maxWidth:'600px',margin:'0 auto',paddingTop:'50px'}}><div style={s.successMessage}><h2 style={{margin:'0 0 10px',fontSize:'24px'}}>‚úì THA Created!</h2><div style={{background:'rgba(255,255,255,0.2)',padding:'8px 16px',borderRadius:'6px',display:'inline-block',margin:'10px 0',fontSize:'20px',fontWeight:'bold'}}>{submittedTHA.thaNumber}</div><div style={{margin:'15px 0'}}><div style={{fontSize:'48px',fontWeight:'bold',color:gradeColors[submittedTHA.qualityGrade]}}>{submittedTHA.qualityGrade}</div><div style={{fontSize:'18px'}}>Score: {submittedTHA.qualityScore}%</div></div><p>THA is now OPEN. Close out at end of shift.</p><div style={{display:'flex',gap:'10px',justifyContent:'center',marginTop:'20px',flexWrap:'wrap'}}><button onClick={resetForm} style={{...s.submitBtn,maxWidth:'200px',background:'white',color:'#059669'}}>Create New THA</button><a href="/" style={{...s.submitBtn,maxWidth:'200px',background:'#6b7280',textDecoration:'none',display:'inline-block',textAlign:'center'}}>Back to Portal</a></div></div></div></div>);}

  return(<div style={s.container}><div style={s.formContainer}>
    <div style={s.header}><a href="/" style={{color:'white',textDecoration:'none',fontSize:'14px'}}>‚Üê Back to Portal</a><div style={{background:'rgba(255,255,255,0.95)',borderRadius:'12px',padding:'15px',width:'fit-content',margin:'15px auto',boxShadow:'0 4px 15px rgba(0,0,0,0.2)'}}><img src="/Logo.png" alt="SLP Alaska" style={{maxWidth:'200px',height:'auto'}}/></div><h1 style={{margin:'0 0 8px',fontSize:'24px'}}>Task Hazard Assessment (THA)</h1><p style={{opacity:0.9,fontSize:'13px'}}>Job Safety Analysis with Real-Time Quality Coaching</p><div style={{display:'inline-block',background:'white',color:'#1e3a8a',padding:'4px 12px',borderRadius:'15px',fontSize:'11px',fontWeight:'600',marginTop:'8px'}}>üìã SWISS CHEESE MODEL VALIDATION</div></div>
    <div style={s.content}>
      <div style={s.tabs}><div style={{...s.tab,...(activeTab==='new'?s.tabActive:{})}} onClick={()=>setActiveTab('new')}>üìù New THA</div><div style={{...s.tab,background:'#fef3c7',borderRadius:'6px 6px 0 0',...(activeTab==='open'?{...s.tabActive,background:'#fcd34d'}:{})}} onClick={()=>setActiveTab('open')}>üìÇ My Open THAs</div><div style={{...s.tab,...(activeTab==='closeout'?s.tabActive:{})}} onClick={()=>setActiveTab('closeout')}>‚úÖ Close Out THA</div></div>

      {activeTab==='new'&&(<form onSubmit={handleSubmit}>
        <div style={{...s.sectionHeader,...s.sectionBlue,marginTop:0}}>üìã General Information</div>
        <div style={s.row}><div style={s.formGroup}><label style={s.label}>Date *</label><input type="date" name="date" value={formData.date} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Company *</label><select name="company" value={formData.company} onChange={handleChange} required style={s.select}><option value="">-- Select --</option>{COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div><div style={s.formGroup}><label style={s.label}>Location *</label><select name="location" value={formData.location} onChange={handleChange} required style={s.select}><option value="">-- Select --</option>{LOCATIONS.map(l=><option key={l} value={l}>{l}</option>)}</select></div></div>
        <div style={s.row}><div style={s.formGroup}><label style={s.label}>Work Area</label><input type="text" name="work_area" value={formData.work_area} onChange={handleChange} placeholder="e.g., Well Pad A-12" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Crew Lead *</label><input type="text" name="crew_lead" value={formData.crew_lead} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Phone/Radio</label><input type="text" name="phone_radio" value={formData.phone_radio} onChange={handleChange} style={s.input}/></div></div>
        <div style={s.formGroup}><label style={s.label}>Task Description *</label><textarea name="task_description" value={formData.task_description} onChange={handleChange} required placeholder="Describe the SPECIFIC work" style={s.textarea}/></div>
        <div style={s.formGroup}><label style={s.label}>Job Planning Notes</label><textarea name="job_planning_notes" value={formData.job_planning_notes} onChange={handleChange} style={s.textarea}/></div>
        <div style={s.row}><div style={s.formGroup}><label style={s.label}>Procedure Exists?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(o=><div key={o} style={{...s.radioOption,...(formData.procedure_exists===o?s.radioOptionSelected:{})}} onClick={()=>setFormData(p=>({...p,procedure_exists:o}))}><input type="radio" checked={formData.procedure_exists===o} readOnly/><span>{o}</span></div>)}</div></div><div style={s.formGroup}><label style={s.label}>Procedure Reviewed?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(o=><div key={o} style={{...s.radioOption,...(formData.procedure_reviewed===o?s.radioOptionSelected:{})}} onClick={()=>setFormData(p=>({...p,procedure_reviewed:o}))}><input type="radio" checked={formData.procedure_reviewed===o} readOnly/><span>{o}</span></div>)}</div></div></div>

        <div style={{...s.sectionHeader,...s.sectionYellow,color:'#000'}}>üöó Driving / Backing</div>
        <div style={s.formGroup}><label style={s.label}>Driving or backing?</label><div style={s.radioGroup}><div style={{...s.radioOption,...(formData.driving_backing?s.radioOptionSelected:{})}} onClick={()=>setFormData(p=>({...p,driving_backing:true}))}><input type="radio" checked={formData.driving_backing} readOnly/><span>Yes</span></div><div style={{...s.radioOption,...(!formData.driving_backing?s.radioOptionSelected:{})}} onClick={()=>setFormData(p=>({...p,driving_backing:false}))}><input type="radio" checked={!formData.driving_backing} readOnly/><span>No</span></div></div></div>
        {formData.driving_backing&&<div style={{background:'#fef3c7',border:'2px solid #f59e0b',borderRadius:'8px',padding:'15px',margin:'15px 0'}}><div style={s.checkboxGrid}>{[{name:'walkaround_360',label:'360¬∞ Walkaround'},{name:'seatbelts_checked',label:'Seatbelts'},{name:'spotter_when_backing',label:'Spotter'},{name:'load_secured',label:'Load Secured'}].map(item=><label key={item.name} style={{...s.checkboxItem,...(formData[item.name]?s.checkboxItemSelected:{})}}><input type="checkbox" name={item.name} checked={formData[item.name]} onChange={handleChange}/><span>{item.label}</span></label>)}</div></div>}

        <div style={{...s.sectionHeader,...s.sectionRed}}>‚ö° Energy Wheel</div>
        <div style={s.energySection}><div style={{color:'#991b1b',fontWeight:'bold',marginBottom:'10px'}}>‚ö° Energy Types Present</div><div style={s.energyGrid}>{ENERGY_TYPES.map(e=><div key={e.value} style={{...s.energyItem,...(formData.energy_types.includes(e.value)?s.energyItemSelected:{})}} onClick={()=>toggleEnergyType(e.value)}><span style={{fontSize:'20px'}}>{e.icon}</span><div><div style={{fontWeight:'500',fontSize:'13px'}}>{e.value}</div><div style={{fontSize:'11px',color:'#666'}}>{e.desc}</div></div></div>)}</div><div style={{marginTop:'20px',paddingTop:'15px',borderTop:'1px solid #fecaca'}}><div style={{color:'#065f46',fontWeight:'bold',marginBottom:'10px'}}>üõ°Ô∏è Control Types</div><div style={s.controlGrid}>{CONTROL_TYPES.map(c=><div key={c.value} style={{...s.controlItem,...(formData.control_types.includes(c.value)?s.controlItemSelected:{})}} onClick={()=>toggleControlType(c.value)}><span>{c.icon}</span><span>{c.value}</span></div>)}</div></div></div>

        <div style={{...s.sectionHeader,...s.sectionBlue}}>‚òëÔ∏è Pre-Task Checklists</div>
        <div style={s.formGroup}><label style={s.label}>General Items</label><div style={s.checkboxGrid}>{GENERAL_ITEMS.map(item=><label key={item} style={{...s.checkboxItem,...(formData.general_items[item]?s.checkboxItemSelected:{})}}><input type="checkbox" checked={formData.general_items[item]||false} onChange={()=>handleCheckboxGroup('general_items',item)}/><span>{item}</span></label>)}</div></div>
        <div style={s.formGroup}><label style={s.label}>PPE Requirements</label><div style={s.checkboxGrid}>{PPE_REQUIREMENTS.map(item=><label key={item} style={{...s.checkboxItem,...(formData.ppe_requirements[item]?s.checkboxItemSelected:{})}}><input type="checkbox" checked={formData.ppe_requirements[item]||false} onChange={()=>handleCheckboxGroup('ppe_requirements',item)}/><span>{item}</span></label>)}</div></div>
        <div style={s.formGroup}><label style={s.label}>Permits Required</label><div style={s.checkboxGrid}>{PERMITS_REQUIRED.map(item=><label key={item} style={{...s.checkboxItem,...(formData.permits_required[item]?s.checkboxItemSelected:{})}}><input type="checkbox" checked={formData.permits_required[item]||false} onChange={()=>handleCheckboxGroup('permits_required',item)}/><span>{item}</span></label>)}</div></div>
        <div style={s.formGroup}><label style={s.label}>Potential Hazards</label><div style={s.checkboxGrid}>{POTENTIAL_HAZARDS.map(item=><label key={item} style={{...s.checkboxItem,...(formData.potential_hazards[item]?s.checkboxItemSelected:{})}}><input type="checkbox" checked={formData.potential_hazards[item]||false} onChange={()=>handleCheckboxGroup('potential_hazards',item)}/><span>{item}</span></label>)}</div></div>

        <div style={{...s.sectionHeader,...s.sectionPurple}}>üìù Task Steps, Hazards & Mitigations</div>
        <div style={{...s.infoBox,...s.infoBoxWarning}}><strong>üéØ GOAL: Paint a picture of the ACTUAL work!</strong></div>
        <table style={s.taskTable}><thead><tr><th style={{...s.taskTableTh,width:'40px'}}>#</th><th style={{...s.taskTableTh,width:'25%'}}>Task Step</th><th style={{...s.taskTableTh,width:'30%'}}>Hazards</th><th style={{...s.taskTableTh,width:'35%'}}>Controls</th><th style={{...s.taskTableTh,width:'50px'}}></th></tr></thead><tbody>{taskSteps.map((step,i)=><tr key={i}><td style={s.taskTableTd}><div style={s.stepNum}>{i+1}</div></td><td style={s.taskTableTd}><textarea value={step.task} onChange={e=>updateTaskStep(i,'task',e.target.value)} placeholder="Be SPECIFIC" style={{...s.textarea,minHeight:'60px'}}/></td><td style={s.taskTableTd}><textarea value={step.hazards} onChange={e=>updateTaskStep(i,'hazards',e.target.value)} placeholder="SPECIFIC hazards" style={{...s.textarea,minHeight:'60px'}}/></td><td style={s.taskTableTd}><textarea value={step.actions} onChange={e=>updateTaskStep(i,'actions',e.target.value)} placeholder="PHYSICAL controls" style={{...s.textarea,minHeight:'60px'}}/></td><td style={s.taskTableTd}><button type="button" onClick={()=>removeTaskStep(i)} style={s.removeBtn}>‚úï</button></td></tr>)}</tbody></table>
        <button type="button" onClick={addTaskStep} style={s.addBtn}>+ Add Step</button>
        <button type="button" onClick={runQualityCheck} style={s.analyzeBtn}>üìä Check THA Quality</button>

        {showQualityPanel&&qualityResults&&<div style={s.qualityPanel}><div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'15px',flexWrap:'wrap',gap:'15px'}}><div style={{fontSize:'16px',fontWeight:'bold'}}>üìä THA QUALITY</div><div style={{...s.bigGrade,background:gradeColors[qualityResults.overallGrade]}}><span style={{fontSize:'36px'}}>{qualityResults.overallGrade}</span><span style={{fontSize:'14px'}}>{qualityResults.overallScore}%</span></div></div><div style={{marginBottom:'15px'}}>{qualityResults.feedback.join(' ')}</div>{qualityResults.strengths.length>0&&<div style={{background:'rgba(255,255,255,0.1)',borderRadius:'8px',padding:'12px',marginBottom:'10px'}}><div style={{fontWeight:'bold',marginBottom:'8px'}}>‚úÖ Strengths</div>{qualityResults.strengths.map((x,i)=><div key={i} style={{fontSize:'13px',color:'#6ee7b7'}}>‚úÖ {x}</div>)}</div>}{qualityResults.improvements.length>0&&<div style={{background:'rgba(255,255,255,0.1)',borderRadius:'8px',padding:'12px',marginBottom:'10px'}}><div style={{fontWeight:'bold',marginBottom:'8px'}}>‚ö†Ô∏è Improve</div>{qualityResults.improvements.map((x,i)=><div key={i} style={{fontSize:'13px',color:'#fcd34d'}}>{x}</div>)}</div>}<div style={{marginTop:'15px',display:'flex',gap:'10px',flexWrap:'wrap'}}>{qualityResults.overallScore>=60&&<button type="button" onClick={()=>setCrewUnlocked(true)} style={{background:'#22c55e',color:'white',border:'none',padding:'10px 20px',borderRadius:'6px',fontWeight:'bold',cursor:'pointer'}}>‚úÖ Proceed to Crew Sign-Off</button>}</div></div>}

        <div style={crewUnlocked?{}:s.crewLocked}><div style={{...s.sectionHeader,...s.sectionGreen}}>üë∑ Crew Sign Off</div>{crewUnlocked&&<div style={{...s.infoBox,...s.infoBoxSuccess}}><strong>‚úÖ Quality check passed!</strong></div>}{!crewUnlocked&&<div style={{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%, -50%)',background:'rgba(0,0,0,0.8)',color:'white',padding:'15px 25px',borderRadius:'8px',fontWeight:'bold',zIndex:10}}>üîí Complete quality check to unlock</div>}<table style={s.crewTable}><thead><tr><th style={{...s.crewTableTh,width:'35%'}}>Name</th><th style={{...s.crewTableTh,width:'30%'}}>Company</th><th style={{...s.crewTableTh,width:'25%'}}>Comments</th><th style={{...s.crewTableTh,width:'10%'}}></th></tr></thead><tbody>{crewMembers.map((c,i)=><tr key={i}><td style={s.taskTableTd}><input type="text" value={c.name} onChange={e=>updateCrewMember(i,'name',e.target.value)} placeholder="Name" style={s.input}/></td><td style={s.taskTableTd}><select value={c.company} onChange={e=>updateCrewMember(i,'company',e.target.value)} style={s.select}><option value="">-- Company --</option>{COMPANIES.map(x=><option key={x} value={x}>{x}</option>)}</select></td><td style={s.taskTableTd}><input type="text" value={c.comments} onChange={e=>updateCrewMember(i,'comments',e.target.value)} style={s.input}/></td><td style={s.taskTableTd}><button type="button" onClick={()=>removeCrewMember(i)} style={s.removeBtn}>‚úï</button></td></tr>)}</tbody></table><button type="button" onClick={addCrewMember} style={s.addBtn}>+ Add Crew</button></div>
        <button type="submit" disabled={isSubmitting||!qualityCheckPassed} style={{...s.submitBtn,opacity:isSubmitting||!qualityCheckPassed?0.5:1,cursor:isSubmitting||!qualityCheckPassed?'not-allowed':'pointer'}}>{isSubmitting?'Submitting...':'Submit THA'}</button>
      </form>)}

      {activeTab==='open'&&<div>{!selectedTHA?<>{loadingOpenTHAs?<div style={{textAlign:'center',padding:'40px'}}>Loading...</div>:openTHAs.length===0?<div style={s.infoBox}>No open THAs.</div>:openTHAs.map(tha=><div key={tha.tha_number} style={s.openThaCard} onClick={()=>loadTHADetails(tha.tha_number)}><div style={{background:'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',padding:'12px 15px',display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontWeight:'bold',color:'#92400e'}}>{tha.tha_number}</span><span style={{background:'#f59e0b',color:'white',padding:'3px 10px',borderRadius:'12px',fontSize:'11px'}}>OPEN</span></div><div style={{padding:'12px 15px',fontSize:'13px'}}><div><strong>Company:</strong> {tha.company}</div><div><strong>Location:</strong> {tha.location}</div><div><strong>Crew Lead:</strong> {tha.crew_lead}</div></div><div style={{background:'#f3f4f6',padding:'10px 15px',display:'flex',justifyContent:'space-between'}}><span>Score: {tha.quality_score}%</span><span style={{padding:'4px 12px',borderRadius:'4px',fontWeight:'bold',color:'white',background:gradeColors[tha.quality_grade]||'#6b7280'}}>Grade: {tha.quality_grade}</span></div></div>)}</>:thaDetails?<><button type="button" onClick={()=>{setSelectedTHA(null);setThaDetails(null);}} style={{background:'none',border:'none',color:'#1e3a8a',cursor:'pointer',marginBottom:'15px'}}>‚Üê Back</button><div style={{background:'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',padding:'20px',borderRadius:'8px',marginBottom:'20px'}}><h3 style={{margin:0,color:'#92400e'}}>{thaDetails.tha_number}</h3><p style={{margin:'5px 0 0',color:'#92400e'}}>{thaDetails.company} | {thaDetails.location}</p></div><div style={{background:'#1e3a8a',color:'white',padding:'15px',borderRadius:'8px',marginBottom:'20px',display:'flex',alignItems:'center',gap:'20px'}}><div style={{...s.bigGrade,width:'60px',height:'60px',background:gradeColors[thaDetails.quality_grade]||'#6b7280'}}><span style={{fontSize:'28px'}}>{thaDetails.quality_grade}</span></div><div><h4 style={{margin:0}}>Score: {thaDetails.quality_score}%</h4></div></div><div style={{border:'1px solid #d1d5db',borderRadius:'8px',marginBottom:'15px',overflow:'hidden'}}><div style={{background:'#f3f4f6',padding:'10px 15px',fontWeight:'600',borderBottom:'1px solid #d1d5db'}}>Current Steps</div><div style={{padding:'15px'}}><table style={{width:'100%',borderCollapse:'collapse',fontSize:'12px'}}><thead><tr><th style={{background:'#e5e7eb',padding:'8px',textAlign:'left'}}>#</th><th style={{background:'#e5e7eb',padding:'8px',textAlign:'left'}}>Task</th><th style={{background:'#e5e7eb',padding:'8px',textAlign:'left'}}>Hazards</th><th style={{background:'#e5e7eb',padding:'8px',textAlign:'left'}}>Controls</th></tr></thead><tbody>{thaDetails.taskSteps.map((x,i)=><tr key={i}><td style={{padding:'8px',borderBottom:'1px solid #e5e7eb'}}>{x.step_number}</td><td style={{padding:'8px',borderBottom:'1px solid #e5e7eb'}}>{x.task_step||'-'}</td><td style={{padding:'8px',borderBottom:'1px solid #e5e7eb'}}>{x.potential_hazards||'-'}</td><td style={{padding:'8px',borderBottom:'1px solid #e5e7eb'}}>{x.recommended_actions||'-'}</td></tr>)}</tbody></table></div></div><div style={{border:'2px solid #f59e0b',borderRadius:'8px',marginBottom:'15px',overflow:'hidden'}}><div style={{background:'#fef3c7',padding:'10px 15px',fontWeight:'600',color:'#92400e'}}>Add New Steps</div><div style={{padding:'15px'}}><table style={s.taskTable}><thead><tr><th style={{...s.taskTableTh,width:'40px'}}>#</th><th style={s.taskTableTh}>Task</th><th style={s.taskTableTh}>Hazards</th><th style={s.taskTableTh}>Controls</th><th style={{...s.taskTableTh,width:'50px'}}></th></tr></thead><tbody>{newTaskSteps.map((x,i)=><tr key={i}><td style={s.taskTableTd}><div style={{...s.stepNum,background:'#f59e0b'}}>{thaDetails.taskSteps.length+i+1}</div></td><td style={s.taskTableTd}><textarea value={x.task} onChange={e=>{const u=[...newTaskSteps];u[i].task=e.target.value;setNewTaskSteps(u);}} style={{...s.textarea,minHeight:'60px'}}/></td><td style={s.taskTableTd}><textarea value={x.hazards} onChange={e=>{const u=[...newTaskSteps];u[i].hazards=e.target.value;setNewTaskSteps(u);}} style={{...s.textarea,minHeight:'60px'}}/></td><td style={s.taskTableTd}><textarea value={x.actions} onChange={e=>{const u=[...newTaskSteps];u[i].actions=e.target.value;setNewTaskSteps(u);}} style={{...s.textarea,minHeight:'60px'}}/></td><td style={s.taskTableTd}><button type="button" onClick={()=>setNewTaskSteps(p=>p.filter((_,j)=>j!==i))} style={s.removeBtn}>‚úï</button></td></tr>)}</tbody></table><button type="button" onClick={()=>setNewTaskSteps(p=>[...p,{task:'',hazards:'',actions:''}])} style={s.addBtn}>+ Add Step</button></div></div><div style={{border:'1px solid #d1d5db',borderRadius:'8px',marginBottom:'15px',overflow:'hidden'}}><div style={{background:'#f3f4f6',padding:'10px 15px',fontWeight:'600'}}>Current Crew</div><div style={{padding:'15px'}}><div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>{thaDetails.crewMembers.map((c,i)=><span key={i} style={{background:'#059669',color:'white',padding:'4px 10px',borderRadius:'15px',fontSize:'12px'}}>{c.crew_member_name}</span>)}</div></div></div><div style={{border:'2px solid #059669',borderRadius:'8px',marginBottom:'15px',overflow:'hidden'}}><div style={{background:'#ecfdf5',padding:'10px 15px',fontWeight:'600',color:'#065f46'}}>Add New Crew</div><div style={{padding:'15px'}}><table style={s.crewTable}><thead><tr><th style={s.crewTableTh}>Name</th><th style={s.crewTableTh}>Company</th><th style={s.crewTableTh}></th></tr></thead><tbody>{newCrewMembers.map((c,i)=><tr key={i}><td style={s.taskTableTd}><input type="text" value={c.name} onChange={e=>{const u=[...newCrewMembers];u[i].name=e.target.value;setNewCrewMembers(u);}} placeholder="Name" style={s.input}/></td><td style={s.taskTableTd}><select value={c.company} onChange={e=>{const u=[...newCrewMembers];u[i].company=e.target.value;setNewCrewMembers(u);}} style={s.select}><option value="">-- Company --</option>{COMPANIES.map(x=><option key={x} value={x}>{x}</option>)}</select></td><td style={s.taskTableTd}><button type="button" onClick={()=>setNewCrewMembers(p=>p.filter((_,j)=>j!==i))} style={s.removeBtn}>‚úï</button></td></tr>)}</tbody></table><button type="button" onClick={()=>setNewCrewMembers(p=>[...p,{name:'',company:'',comments:''}])} style={s.addBtn}>+ Add Crew</button></div></div>{updateSuccess&&<div style={s.successMessage}><h2 style={{margin:0}}>‚úì Updated!</h2></div>}<div style={{display:'flex',gap:'10px',flexWrap:'wrap'}}><button type="button" onClick={saveUpdates} disabled={isSubmitting} style={{...s.submitBtn,background:'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',flex:1}}>{isSubmitting?'Saving...':'üíæ Save'}</button><button type="button" onClick={()=>{setCloseoutThaNumber(selectedTHA);setActiveTab('closeout');}} style={{...s.submitBtn,background:'linear-gradient(135deg, #059669 0%, #047857 100%)',flex:1}}>‚úÖ Close Out</button></div></>:<div>Loading...</div>}</div>}

      {activeTab==='closeout'&&<div>{closeoutSuccess?<div style={s.successMessage}><h2 style={{margin:'0 0 10px'}}>‚úì THA Closed!</h2><button type="button" onClick={resetCloseout} style={{...s.submitBtn,maxWidth:'250px',background:'white',color:'#059669',marginTop:'15px'}}>Close Another</button></div>:<><div style={{...s.sectionHeader,...s.sectionGreen,marginTop:0}}>‚úÖ Close Out THA</div><div style={s.formGroup}><label style={s.label}>THA Number *</label><input type="text" value={closeoutThaNumber} onChange={e=>setCloseoutThaNumber(e.target.value)} placeholder="THA-XXXXXXXX-XXXX" style={s.input}/></div>{openTHAs.length>0&&<div style={{marginBottom:'20px'}}><p style={{fontSize:'13px',marginBottom:'10px'}}><strong>Or select:</strong></p><div style={{maxHeight:'150px',overflowY:'auto',border:'1px solid #e5e7eb',borderRadius:'6px'}}>{openTHAs.map(t=><div key={t.tha_number} style={{padding:'8px',borderBottom:'1px solid #e5e7eb',cursor:'pointer',fontSize:'12px'}} onClick={()=>setCloseoutThaNumber(t.tha_number)}><strong>{t.tha_number}</strong> - {t.company}</div>)}</div></div>}<div style={s.closeoutSection}><h4 style={{margin:'0 0 15px',color:'#065f46'}}>üìã Post-Task Review</h4><div style={s.row}><div style={s.formGroup}><label style={s.label}>Scope changed?</label><div style={s.radioGroup}>{['Yes','No'].map(o=><div key={o} style={{...s.radioOption,...(closeoutData.scope_changed===o?s.radioOptionSelected:{})}} onClick={()=>setCloseoutData(p=>({...p,scope_changed:o}))}><input type="radio" checked={closeoutData.scope_changed===o} readOnly/><span>{o}</span></div>)}</div></div><div style={s.formGroup}><label style={s.label}>THA updated?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(o=><div key={o} style={{...s.radioOption,...(closeoutData.tha_updated_if_changed===o?s.radioOptionSelected:{})}} onClick={()=>setCloseoutData(p=>({...p,tha_updated_if_changed:o}))}><input type="radio" checked={closeoutData.tha_updated_if_changed===o} readOnly/><span>{o}</span></div>)}</div></div></div></div><div style={{...s.sectionHeader,...s.sectionCyan}}>‚òëÔ∏è End of Shift</div><div style={s.closeoutChecklist}>{[{key:'client_rep_visited',label:'üëî Client Rep visited?'},{key:'hse_visited',label:'ü¶∫ HSE visited?'},{key:'job_stopped',label:'üõë Job stopped?'},{key:'housekeeping_complete',label:'üßπ Housekeeping complete?'},{key:'all_permits_closed',label:'üìù Permits closed?'},{key:'info_passed_to_oncoming',label:'üîÑ Info passed?'}].map(item=><label key={item.key} style={{...s.closeoutCheckItem,...(closeoutData[item.key]?s.closeoutCheckItemChecked:{})}} onClick={()=>setCloseoutData(p=>({...p,[item.key]:!p[item.key]}))}><input type="checkbox" checked={closeoutData[item.key]} readOnly style={{width:'20px',height:'20px'}}/><span style={{fontSize:'13px'}}>{item.label}</span></label>)}</div><div style={{...s.sectionHeader,background:'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'}}>üéØ After Action Review</div><div style={s.aarSection}><div style={{marginBottom:'15px'}}><label style={{...s.label,fontWeight:'600',color:'#1e40af'}}>1. What went well? ‚úÖ</label><textarea value={closeoutData.aar_went_well} onChange={e=>setCloseoutData(p=>({...p,aar_went_well:e.target.value}))} placeholder="What worked?" style={{...s.textarea,minHeight:'80px'}}/></div><div style={{marginBottom:'15px'}}><label style={{...s.label,fontWeight:'600',color:'#1e40af'}}>2. What didn't go as planned? ‚ö†Ô∏è</label><textarea value={closeoutData.aar_didnt_go_as_planned} onChange={e=>setCloseoutData(p=>({...p,aar_didnt_go_as_planned:e.target.value}))} placeholder="Challenges?" style={{...s.textarea,minHeight:'80px'}}/></div><div><label style={{...s.label,fontWeight:'600',color:'#1e40af'}}>3. How will we improve? üìà</label><textarea value={closeoutData.aar_how_improve} onChange={e=>setCloseoutData(p=>({...p,aar_how_improve:e.target.value}))} placeholder="Improvements?" style={{...s.textarea,minHeight:'80px'}}/></div></div><div style={{...s.sectionHeader,...s.sectionPurple}}>üìù Additional Info</div><div style={s.formGroup}><label style={s.label}>Lessons Learned</label><textarea value={closeoutData.lessons_learned} onChange={e=>setCloseoutData(p=>({...p,lessons_learned:e.target.value}))} style={s.textarea}/></div><div style={s.formGroup}><label style={s.label}>Crew Comments</label><textarea value={closeoutData.crew_comments} onChange={e=>setCloseoutData(p=>({...p,crew_comments:e.target.value}))} style={s.textarea}/></div><div style={s.formGroup}><label style={s.label}>Closed By *</label><input type="text" value={closeoutData.closed_by} onChange={e=>setCloseoutData(p=>({...p,closed_by:e.target.value}))} placeholder="Your name" style={s.input}/></div><button type="button" onClick={submitCloseout} disabled={isSubmitting} style={{...s.submitBtn,background:'linear-gradient(135deg, #059669 0%, #047857 100%)',opacity:isSubmitting?0.5:1}}>{isSubmitting?'Closing...':'‚úÖ Close Out THA'}</button></>}</div>}
    </div>
    <div style={{textAlign:'center',padding:'20px',background:'linear-gradient(to bottom, #f8fafc, #ffffff)',color:'#64748b',fontSize:'11px',borderTop:'1px solid #e2e8f0'}}><span style={{color:'#1e3a5f',fontWeight:'500'}}>Powered by Predictive Safety Analytics‚Ñ¢</span><span style={{color:'#94a3b8',margin:'0 8px'}}>|</span><span style={{color:'#475569'}}>¬© 2025 SLP Alaska</span></div>
  </div></div>);
}
