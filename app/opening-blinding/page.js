'use client';
import { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  'https://iypezirwdlqpptjpeeyf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5cGV6aXJ3ZGxxcHB0anBlZXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2Nzg3NzYsImV4cCI6MjA4NDI1NDc3Nn0.rfTN8fi9rd6o5rX-scAg9I1BbC-UjM8WoWEXDbrYJD4'
);

const COMPANIES = ['A-C Electric','AKE-Line','Apache Corp.','Armstrong Oil & Gas','ASRC Energy Services','CCI-Industrial','Chosen Construction','CINGSA','Coho Enterprises','Conam Construction','ConocoPhillips','Five Star Oilfield Services','Fox Energy Services','G.A. West','GBR Equipment','GLM Energy Services','Graham Industrial Coatings','Harvest Midstream','Hilcorp Alaska','MagTec Alaska','Merkes Builders','Nordic-Calista','Parker TRS','Peninsula Paving','Pollard Wireline','Ridgeline Oilfield Services','Santos','Summit Excavation','Tesoro Refinery','Yellowjacket','Other'];
const LOCATIONS = ['Kenai','CIO','Beaver Creek','Swanson River','Ninilchik','Nikiski','Other Kenai Asset','Deadhorse','Prudhoe Bay','Kuparuk','Alpine','Willow','ENI','PIKKA','Point Thompson','North Star Island','Endicott','Badami','Other North Slope'];
const OPENING_TYPES = ['Flange Break','Valve Removal','Pipe Cut','Equipment Opening','Filter/Strainer Service','Pump Seal Replacement','Instrument Removal','Vessel Entry','Other'];
const PROCESS_CONTENTS = ['Crude Oil','Natural Gas','Condensate','Produced Water','Glycol','Methanol','Diesel','Hydraulic Fluid','Lube Oil','Steam','Compressed Air','Nitrogen','Chemical','Other'];
const BLIND_RATINGS = ['150#','300#','600#','900#','1500#','2500#'];
const PURGE_METHODS = ['Nitrogen Purge','Steam Purge','Water Flush','Air Purge','Chemical Cleaning','Other'];
const RESPIRATORY_TYPES = ['Half-Face APR','Full-Face APR','PAPR','Supplied Air','SCBA','Escape Pack'];
const HAZMAT_ITEMS = [{id:'flammable',label:'üî• Flammable Contents'},{id:'toxic',label:'‚ò†Ô∏è Toxic Contents'},{id:'corrosive',label:'‚öóÔ∏è Corrosive Contents'},{id:'h2s',label:'üíÄ H2S Present'},{id:'benzene',label:'‚ö†Ô∏è Benzene Present'},{id:'asbestos',label:'üèóÔ∏è Asbestos Present'},{id:'norm',label:'‚ò¢Ô∏è NORM Present'},{id:'pyrophoric',label:'üí• Pyrophoric Materials'},{id:'inert',label:'üå´Ô∏è Inert Atmosphere'},{id:'other',label:'‚ùì Other Hazmat'}];
const PPE_ITEMS = [{id:'faceShield',label:'Face Shield'},{id:'chemGoggles',label:'Chemical Splash Goggles'},{id:'hardHat',label:'Hard Hat'},{id:'chemGloves',label:'Chemical Resistant Gloves'},{id:'leatherGloves',label:'Leather Gloves'},{id:'chemSuit',label:'Chemical Suit'},{id:'tyvekSuit',label:'Tyvek Suit'},{id:'frClothing',label:'FR Clothing'},{id:'steelToe',label:'Steel Toe Boots'},{id:'rubberBoots',label:'Rubber Boots'},{id:'hearing',label:'Hearing Protection'},{id:'fallProtection',label:'Fall Protection'}];
const SAFEGUARD_ITEMS = [{id:'continuousMonitoring',label:'Continuous Atmospheric Monitoring'},{id:'fireWatch',label:'Fire Watch Required'},{id:'spillContainment',label:'Spill Containment'},{id:'drainBasin',label:'Drain/Catch Basin'},{id:'absorbent',label:'Absorbent Materials'},{id:'emergencyShower',label:'Emergency Shower Nearby'},{id:'eyewash',label:'Eyewash Available'},{id:'fireExtinguisher',label:'Fire Extinguisher'},{id:'windDirection',label:'Wind Direction Considered'},{id:'barricades',label:'Barricades/Signs Posted'}];
const VERIFICATION_ITEMS = [{id:'preJobBriefing',label:'Pre-Job Briefing Conducted'},{id:'hazardsCommunicated',label:'Hazards Communicated to Crew'},{id:'emergencyProcedures',label:'Emergency Procedures Reviewed'},{id:'isolationsVerified',label:'All Isolations Verified'},{id:'operatorNotified',label:'Operator Notified'},{id:'controlRoomNotified',label:'Control Room Notified'}];

function generatePermitNumber(){const now=new Date();const d=now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0');return 'POB-'+d+'-'+String(Math.floor(Math.random()*10000)).padStart(4,'0');}

function calculateIndicators(data){
  let good=0,bad=0;const notes=[];
  if(data.verification?.preJobBriefing){good++;notes.push('Pre-Job Briefing Conducted');}
  if(data.verification?.hazardsCommunicated)good++;
  if(data.verification?.isolationsVerified){good++;notes.push('All Isolations Verified');}
  if(data.lotoRequired==='Yes'&&data.lotoVerified==='Yes'){good++;notes.push('LOTO Verified');}
  if(data.pressureVerifiedZero==='Yes'){good++;notes.push('Zero Pressure Verified');}
  if(data.lineDrained==='Yes')good++;
  if(data.lineDepressurized==='Yes')good++;
  if(data.verification?.operatorNotified)good++;
  if(data.verification?.controlRoomNotified)good++;
  if(data.atmosphericTestRequired==='Yes'&&data.atmosphericTestPass==='Yes')good++;
  if(data.safeguards?.spillContainment)good++;
  if(data.pressureVerifiedZero!=='Yes'){bad++;notes.push('Pressure not verified zero');}
  if(data.lotoRequired==='Yes'&&data.lotoVerified!=='Yes'){bad++;notes.push('LOTO Required but not verified');}
  if(!data.verification?.isolationsVerified){bad++;notes.push('Isolations not verified');}
  if(!data.verification?.preJobBriefing){bad++;notes.push('No Pre-Job Briefing');}
  if(data.atmosphericTestRequired==='Yes'&&data.atmosphericTestPass!=='Yes'){bad+=2;notes.push('CRITICAL: Atmospheric test failed');}
  if((data.hazardousMaterials?.flammable||data.hazardousMaterials?.h2s)&&!data.safeguards?.continuousMonitoring){bad++;notes.push('Flammable/H2S without continuous monitoring');}
  if(data.hazardousMaterials?.corrosive&&!data.requiredPpe?.chemGloves){bad++;notes.push('Corrosive without chemical gloves');}
  if(data.hazardousMaterials?.pyrophoric&&!data.hazardousMaterials?.inert){bad++;notes.push('Pyrophoric without inert atmosphere');}
  return {good,bad,notes};
}

export default function OpeningBlindingPermit(){
  const [activeTab,setActiveTab]=useState('new');
  const [isSubmitting,setIsSubmitting]=useState(false);
  const [submitted,setSubmitted]=useState(false);
  const [submittedPermit,setSubmittedPermit]=useState(null);
  const [openPermits,setOpenPermits]=useState([]);
  const [selectedPermit,setSelectedPermit]=useState(null);
  const [closeoutSuccess,setCloseoutSuccess]=useState(false);
  
  const [formData,setFormData]=useState({
    permitInitiator:'',date:new Date().toISOString().split('T')[0],company:'',location:'',phoneRadio:'',workArea:'',lineEquipmentId:'',openingType:'',processContents:'',purposeOfOpening:'',
    normalOperatingPressure:'',normalOperatingTemp:'',currentPressure:'',currentTemperature:'',pressureVerifiedZero:'',temperatureSafe:'',
    hazardousMaterials:{},otherHazmatDescription:'',
    lotoRequired:'',lotoPermitNumber:'',lotoVerified:'',doubleBlockAndBleed:'',singleBlockAndBleed:'',lineBlindingRequired:'',blindLocation:'',blindSize:'',blindRating:'',spectacleBlind:false,paddleBlind:false,slipPlate:false,lineDrained:'',lineDepressurized:'',linePurged:'',purgeMethod:'',
    atmosphericTestRequired:'',oxygenLevel:'',lelLevel:'',h2sLevel:'',benzeneLevel:'',atmosphericTestPass:'',
    requiredPpe:{},respiratoryProtection:'',respiratoryType:'',
    safeguards:{},hotWorkPermitRequired:'',confinedSpaceEntryRequired:'',
    verification:{},
    responsibleOperator:'',areaSupervisor:'',performingSupervisor:'',startTime:'',expirationTime:''
  });
  
  const [closeoutData,setCloseoutData]=useState({lineRestored:false,blindsRemoved:false,systemPressureTested:false,leakCheckPerformed:false,timePermitClosed:'',closeOutOperator:'',closeOutSupervisor:''});

  useEffect(()=>{if(activeTab==='closeout')loadOpenPermits();},[activeTab]);

  const loadOpenPermits=async()=>{try{const{data}=await supabase.from('opening_blinding_permits').select('*').eq('permit_status','Open').order('created_at',{ascending:false});setOpenPermits(data||[]);}catch(e){console.error(e);}};

  const handleChange=(e)=>{const{name,value}=e.target;setFormData(p=>({...p,[name]:value}));};
  const handleHazmatToggle=(id)=>{setFormData(p=>({...p,hazardousMaterials:{...p.hazardousMaterials,[id]:!p.hazardousMaterials[id]}}));};
  const handlePpeToggle=(id)=>{setFormData(p=>({...p,requiredPpe:{...p.requiredPpe,[id]:!p.requiredPpe[id]}}));};
  const handleSafeguardToggle=(id)=>{setFormData(p=>({...p,safeguards:{...p.safeguards,[id]:!p.safeguards[id]}}));};
  const handleVerificationToggle=(id)=>{setFormData(p=>({...p,verification:{...p.verification,[id]:!p.verification[id]}}));};

  const handleSubmit=async(e)=>{e.preventDefault();setIsSubmitting(true);
    try{
      const permitNumber=generatePermitNumber();
      const indicators=calculateIndicators(formData);
      
      const{error}=await supabase.from('opening_blinding_permits').insert([{
        permit_number:permitNumber,permit_status:'Open',permit_initiator:formData.permitInitiator,date:formData.date,company:formData.company,location:formData.location,phone_radio:formData.phoneRadio,work_area:formData.workArea,line_equipment_id:formData.lineEquipmentId,opening_type:formData.openingType,process_contents:formData.processContents,purpose_of_opening:formData.purposeOfOpening,
        normal_operating_pressure:formData.normalOperatingPressure,normal_operating_temp:formData.normalOperatingTemp,current_pressure:formData.currentPressure,current_temperature:formData.currentTemperature,pressure_verified_zero:formData.pressureVerifiedZero,temperature_safe:formData.temperatureSafe,
        hazardous_materials:formData.hazardousMaterials,other_hazmat_description:formData.otherHazmatDescription,
        loto_required:formData.lotoRequired,loto_permit_number:formData.lotoPermitNumber,loto_verified:formData.lotoVerified,double_block_and_bleed:formData.doubleBlockAndBleed,single_block_and_bleed:formData.singleBlockAndBleed,line_blinding_required:formData.lineBlindingRequired,blind_location:formData.blindLocation,blind_size:formData.blindSize,blind_rating:formData.blindRating,spectacle_blind:formData.spectacleBlind?'Yes':'',paddle_blind:formData.paddleBlind?'Yes':'',slip_plate:formData.slipPlate?'Yes':'',line_drained:formData.lineDrained,line_depressurized:formData.lineDepressurized,line_purged:formData.linePurged,purge_method:formData.purgeMethod,
        atmospheric_test_required:formData.atmosphericTestRequired,oxygen_level:formData.oxygenLevel,lel_level:formData.lelLevel,h2s_level:formData.h2sLevel,benzene_level:formData.benzeneLevel,atmospheric_test_pass:formData.atmosphericTestPass,
        required_ppe:formData.requiredPpe,respiratory_protection:formData.respiratoryProtection,respiratory_type:formData.respiratoryType,
        safeguards:formData.safeguards,hot_work_permit_required:formData.hotWorkPermitRequired,confined_space_entry_required:formData.confinedSpaceEntryRequired,
        verification:formData.verification,
        responsible_operator:formData.responsibleOperator,area_supervisor:formData.areaSupervisor,performing_supervisor:formData.performingSupervisor,start_time:formData.startTime||null,expiration_time:formData.expirationTime||null,
        good_indicators:indicators.good,bad_indicators:indicators.bad,indicator_notes:indicators.notes.join('; ')
      }]);
      if(error)throw error;
      setSubmittedPermit(permitNumber);setSubmitted(true);
    }catch(e){console.error(e);alert('Error: '+e.message);}finally{setIsSubmitting(false);}
  };

  const submitCloseout=async()=>{if(!selectedPermit){alert('Select a permit');return;}if(!closeoutData.closeOutOperator||!closeoutData.closeOutSupervisor){alert('Fill required fields');return;}
    setIsSubmitting(true);try{
      const{error}=await supabase.from('opening_blinding_permits').update({permit_status:'Closed',line_restored:closeoutData.lineRestored?'Yes':'',blinds_removed:closeoutData.blindsRemoved?'Yes':'',system_pressure_tested:closeoutData.systemPressureTested?'Yes':'',leak_check_performed:closeoutData.leakCheckPerformed?'Yes':'',time_permit_closed:closeoutData.timePermitClosed||null,close_out_operator:closeoutData.closeOutOperator,close_out_supervisor:closeoutData.closeOutSupervisor,closed_at:new Date().toISOString()}).eq('permit_number',selectedPermit);
      if(error)throw error;setCloseoutSuccess(true);
    }catch(e){console.error(e);alert('Error: '+e.message);}finally{setIsSubmitting(false);}
  };

  const resetForm=()=>{setFormData({permitInitiator:'',date:new Date().toISOString().split('T')[0],company:'',location:'',phoneRadio:'',workArea:'',lineEquipmentId:'',openingType:'',processContents:'',purposeOfOpening:'',normalOperatingPressure:'',normalOperatingTemp:'',currentPressure:'',currentTemperature:'',pressureVerifiedZero:'',temperatureSafe:'',hazardousMaterials:{},otherHazmatDescription:'',lotoRequired:'',lotoPermitNumber:'',lotoVerified:'',doubleBlockAndBleed:'',singleBlockAndBleed:'',lineBlindingRequired:'',blindLocation:'',blindSize:'',blindRating:'',spectacleBlind:false,paddleBlind:false,slipPlate:false,lineDrained:'',lineDepressurized:'',linePurged:'',purgeMethod:'',atmosphericTestRequired:'',oxygenLevel:'',lelLevel:'',h2sLevel:'',benzeneLevel:'',atmosphericTestPass:'',requiredPpe:{},respiratoryProtection:'',respiratoryType:'',safeguards:{},hotWorkPermitRequired:'',confinedSpaceEntryRequired:'',verification:{},responsibleOperator:'',areaSupervisor:'',performingSupervisor:'',startTime:'',expirationTime:''});setSubmitted(false);setSubmittedPermit(null);};
  const resetCloseout=()=>{setCloseoutData({lineRestored:false,blindsRemoved:false,systemPressureTested:false,leakCheckPerformed:false,timePermitClosed:'',closeOutOperator:'',closeOutSupervisor:''});setSelectedPermit(null);setCloseoutSuccess(false);loadOpenPermits();};

  const s={container:{minHeight:'100vh',background:'linear-gradient(135deg, #1e3a8a 0%, #b91c1c 100%)',padding:'20px'},formContainer:{maxWidth:'1000px',margin:'0 auto',background:'white',borderRadius:'12px',boxShadow:'0 4px 6px rgba(0,0,0,0.1)',overflow:'hidden'},header:{background:'linear-gradient(135deg, #1e3a8a 0%, #b91c1c 100%)',color:'white',padding:'25px',textAlign:'center'},content:{padding:'25px'},tabs:{display:'flex',background:'#f1f5f9',padding:'8px',gap:'8px'},tab:{flex:1,padding:'12px',border:'none',borderRadius:'8px',fontWeight:'600',cursor:'pointer',fontSize:'14px',transition:'all 0.2s'},tabActive:{background:'#1e3a8a',color:'white'},tabInactive:{background:'white',color:'#475569'},section:{marginBottom:'15px',border:'1px solid #e5e7eb',borderRadius:'10px',overflow:'hidden'},sectionHeader:{color:'white',padding:'10px 15px',fontWeight:'600',fontSize:'14px'},sectionBlue:{background:'linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%)'},sectionRed:{background:'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)'},sectionGreen:{background:'linear-gradient(135deg, #059669 0%, #047857 100%)'},sectionPurple:{background:'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)'},sectionCyan:{background:'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)'},sectionAmber:{background:'linear-gradient(135deg, #ca8a04 0%, #a16207 100%)'},sectionOrange:{background:'linear-gradient(135deg, #ea580c 0%, #c2410c 100%)'},sectionBody:{padding:'12px',background:'#f8fafc'},formRow:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))',gap:'12px',marginBottom:'12px'},formGroup:{display:'flex',flexDirection:'column'},label:{fontWeight:'600',color:'#374151',marginBottom:'4px',fontSize:'13px'},required:{color:'#b91c1c'},input:{padding:'8px 10px',border:'2px solid #d1d5db',borderRadius:'6px',fontSize:'14px'},select:{padding:'8px 10px',border:'2px solid #d1d5db',borderRadius:'6px',fontSize:'14px',background:'white'},textarea:{padding:'8px 10px',border:'2px solid #d1d5db',borderRadius:'6px',fontSize:'14px',minHeight:'60px',resize:'vertical'},infoBox:{background:'#dbeafe',borderLeft:'4px solid #3b82f6',padding:'10px',marginBottom:'12px',fontSize:'13px',borderRadius:'0 6px 6px 0'},warningBox:{background:'#fef3c7',borderLeft:'4px solid #f59e0b',padding:'10px',marginBottom:'12px',fontSize:'13px',borderRadius:'0 6px 6px 0'},criticalBox:{background:'#fee2e2',borderLeft:'4px solid #dc2626',padding:'10px',marginBottom:'12px',fontSize:'13px',borderRadius:'0 6px 6px 0'},checkboxGrid:{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(200px, 1fr))',gap:'8px'},checkboxItem:{display:'flex',alignItems:'center',background:'white',padding:'8px 10px',borderRadius:'6px',border:'2px solid #e5e7eb',cursor:'pointer',fontSize:'13px',transition:'all 0.2s'},checkboxItemChecked:{borderColor:'#1e3a8a',background:'#dbeafe'},checkboxItemHazmat:{borderColor:'#dc2626',background:'#fee2e2'},radioGroup:{display:'flex',gap:'10px',flexWrap:'wrap'},radioItem:{display:'flex',alignItems:'center',gap:'6px',padding:'8px 12px',background:'white',border:'2px solid #e5e7eb',borderRadius:'6px',cursor:'pointer',fontSize:'13px'},radioItemSelected:{borderColor:'#1e3a8a',background:'#dbeafe'},verificationItem:{display:'flex',alignItems:'center',background:'white',padding:'10px',borderRadius:'6px',marginBottom:'6px',cursor:'pointer',border:'1px solid #e5e7eb'},verificationItemChecked:{background:'#dcfce7',borderLeft:'3px solid #059669'},submitBtn:{width:'100%',padding:'14px',background:'linear-gradient(135deg, #1e3a8a 0%, #b91c1c 100%)',color:'white',border:'none',borderRadius:'10px',fontSize:'16px',fontWeight:'600',cursor:'pointer',marginTop:'15px'},submitBtnGreen:{background:'linear-gradient(135deg, #059669 0%, #047857 100%)'},successMessage:{background:'linear-gradient(135deg, #059669 0%, #047857 100%)',color:'white',padding:'30px',borderRadius:'12px',textAlign:'center',margin:'20px 0'},permitCard:{background:'white',border:'2px solid #e5e7eb',borderRadius:'8px',padding:'12px',marginBottom:'10px',cursor:'pointer',transition:'all 0.2s'},permitCardSelected:{borderColor:'#059669',background:'#f0fdf4'},blindDetails:{background:'white',border:'2px solid #7c3aed',borderRadius:'8px',padding:'15px',marginTop:'10px'}};

  if(submitted&&submittedPermit){return(<div style={s.container}><div style={{maxWidth:'600px',margin:'0 auto',paddingTop:'50px'}}><div style={s.successMessage}><div style={{fontSize:'48px',marginBottom:'15px'}}>‚úÖ</div><h2 style={{margin:'0 0 10px'}}>Permit Issued Successfully!</h2><div style={{background:'rgba(255,255,255,0.2)',padding:'12px',borderRadius:'8px',fontSize:'20px',fontWeight:'bold',margin:'15px 0'}}>{submittedPermit}</div><p>All isolations must be verified before line break.</p><div style={{display:'flex',gap:'10px',justifyContent:'center',marginTop:'20px',flexWrap:'wrap'}}><button onClick={resetForm} style={{...s.submitBtn,maxWidth:'200px',background:'white',color:'#059669'}}>Issue Another</button><a href="/" style={{...s.submitBtn,maxWidth:'200px',background:'#6b7280',textDecoration:'none',textAlign:'center'}}>Back to Portal</a></div></div></div></div>);}

  return(<div style={s.container}><div style={s.formContainer}>
    <div style={s.header}><a href="/" style={{color:'white',textDecoration:'none',fontSize:'14px'}}>‚Üê Back to Portal</a><div style={{background:'rgba(255,255,255,0.95)',borderRadius:'12px',padding:'15px',width:'fit-content',margin:'15px auto',boxShadow:'0 4px 15px rgba(0,0,0,0.2)'}}><img src="/Logo.png" alt="SLP Alaska" style={{maxWidth:'180px',height:'auto'}}/></div><div style={{display:'inline-block',background:'white',color:'#ca8a04',padding:'5px 14px',borderRadius:'20px',fontWeight:'700',fontSize:'12px',marginBottom:'12px',border:'3px solid white'}}>üîß OSHA 1910.147 | API RP 2016</div><h1 style={{margin:'0 0 5px',fontSize:'20px'}}>Process Opening/Blinding Permit</h1><p style={{opacity:0.9,fontSize:'13px'}}>Line Breaking & Pipe Opening Safety</p></div>
    
    <div style={s.tabs}><button style={{...s.tab,...(activeTab==='new'?s.tabActive:s.tabInactive)}} onClick={()=>setActiveTab('new')}>üìù New Permit</button><button style={{...s.tab,...(activeTab==='closeout'?s.tabActive:s.tabInactive)}} onClick={()=>setActiveTab('closeout')}>‚úÖ Close Out Permit</button></div>
    
    <div style={s.content}>
      {activeTab==='new'&&(<form onSubmit={handleSubmit}>
        {/* PERMIT INFO */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionBlue}}>üìã Permit Information</div><div style={s.sectionBody}>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Permit Initiator <span style={s.required}>*</span></label><input type="text" name="permitInitiator" value={formData.permitInitiator} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Date <span style={s.required}>*</span></label><input type="date" name="date" value={formData.date} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Company <span style={s.required}>*</span></label><select name="company" value={formData.company} onChange={handleChange} required style={s.select}><option value="">Select...</option>{COMPANIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div></div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Location <span style={s.required}>*</span></label><select name="location" value={formData.location} onChange={handleChange} required style={s.select}><option value="">Select...</option>{LOCATIONS.map(l=><option key={l} value={l}>{l}</option>)}</select></div><div style={s.formGroup}><label style={s.label}>Phone/Radio</label><input type="text" name="phoneRadio" value={formData.phoneRadio} onChange={handleChange} style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Work Area/Unit <span style={s.required}>*</span></label><input type="text" name="workArea" value={formData.workArea} onChange={handleChange} required placeholder="e.g., Unit 100, Tank Farm" style={s.input}/></div></div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Line/Equipment ID <span style={s.required}>*</span></label><input type="text" name="lineEquipmentId" value={formData.lineEquipmentId} onChange={handleChange} required placeholder="e.g., P-101, V-2001" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Opening Type <span style={s.required}>*</span></label><select name="openingType" value={formData.openingType} onChange={handleChange} required style={s.select}><option value="">Select...</option>{OPENING_TYPES.map(t=><option key={t} value={t}>{t}</option>)}</select></div><div style={s.formGroup}><label style={s.label}>Process Contents <span style={s.required}>*</span></label><select name="processContents" value={formData.processContents} onChange={handleChange} required style={s.select}><option value="">Select...</option>{PROCESS_CONTENTS.map(c=><option key={c} value={c}>{c}</option>)}</select></div></div>
          <div style={s.formGroup}><label style={s.label}>Purpose of Opening <span style={s.required}>*</span></label><textarea name="purposeOfOpening" value={formData.purposeOfOpening} onChange={handleChange} required placeholder="Describe the reason for opening..." style={s.textarea}/></div>
        </div></div>
        
        {/* PROCESS CONDITIONS */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionAmber}}>üå°Ô∏è Process Conditions</div><div style={s.sectionBody}>
          <div style={s.warningBox}>‚ö†Ô∏è Verify process conditions before initiating any line break. Pressure must be verified at ZERO before opening.</div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Normal Operating Pressure (PSI)</label><input type="text" name="normalOperatingPressure" value={formData.normalOperatingPressure} onChange={handleChange} placeholder="e.g., 150" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Normal Operating Temp (¬∞F)</label><input type="text" name="normalOperatingTemp" value={formData.normalOperatingTemp} onChange={handleChange} placeholder="e.g., 200" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Current Pressure (PSI) <span style={s.required}>*</span></label><input type="text" name="currentPressure" value={formData.currentPressure} onChange={handleChange} required placeholder="Must be 0" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Current Temperature (¬∞F) <span style={s.required}>*</span></label><input type="text" name="currentTemperature" value={formData.currentTemperature} onChange={handleChange} required placeholder="e.g., Ambient" style={s.input}/></div></div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Pressure Verified Zero? <span style={s.required}>*</span></label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.pressureVerifiedZero===v?s.radioItemSelected:{})}}><input type="radio" name="pressureVerifiedZero" value={v} checked={formData.pressureVerifiedZero===v} onChange={handleChange} required/><span>{v}</span></label>)}</div></div><div style={s.formGroup}><label style={s.label}>Temperature Safe for Work? <span style={s.required}>*</span></label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.temperatureSafe===v?s.radioItemSelected:{})}}><input type="radio" name="temperatureSafe" value={v} checked={formData.temperatureSafe===v} onChange={handleChange} required/><span>{v}</span></label>)}</div></div></div>
        </div></div>
        
        {/* HAZARDOUS MATERIALS */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionRed}}>‚ò£Ô∏è Hazardous Materials Present</div><div style={s.sectionBody}>
          <div style={s.criticalBox}>üö® CRITICAL: Identify ALL hazardous materials. This determines required PPE and safety precautions.</div>
          <div style={s.checkboxGrid}>{HAZMAT_ITEMS.map(h=><div key={h.id} style={{...s.checkboxItem,...(formData.hazardousMaterials[h.id]?s.checkboxItemHazmat:{})}} onClick={()=>handleHazmatToggle(h.id)}><input type="checkbox" checked={formData.hazardousMaterials[h.id]||false} readOnly style={{marginRight:'8px',accentColor:'#dc2626'}}/><span>{h.label}</span></div>)}</div>
          {formData.hazardousMaterials.other&&<div style={{...s.formGroup,marginTop:'12px'}}><label style={s.label}>Other Hazardous Material Description</label><input type="text" name="otherHazmatDescription" value={formData.otherHazmatDescription} onChange={handleChange} placeholder="Specify other hazmat..." style={s.input}/></div>}
        </div></div>
        
        {/* ISOLATION REQUIREMENTS */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionPurple}}>üîí Isolation Requirements</div><div style={s.sectionBody}>
          <div style={s.infoBox}>‚ÑπÔ∏è Proper isolation is critical for safe line breaking. Double block and bleed is preferred for hazardous contents.</div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>LOTO Required? <span style={s.required}>*</span></label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.lotoRequired===v?s.radioItemSelected:{})}}><input type="radio" name="lotoRequired" value={v} checked={formData.lotoRequired===v} onChange={handleChange} required/><span>{v}</span></label>)}</div></div>{formData.lotoRequired==='Yes'&&<><div style={s.formGroup}><label style={s.label}>LOTO Permit Number</label><input type="text" name="lotoPermitNumber" value={formData.lotoPermitNumber} onChange={handleChange} placeholder="e.g., EI-20260127-0001" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>LOTO Verified?</label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.lotoVerified===v?s.radioItemSelected:{})}}><input type="radio" name="lotoVerified" value={v} checked={formData.lotoVerified===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div></>}</div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Double Block and Bleed?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(v=><label key={v} style={{...s.radioItem,...(formData.doubleBlockAndBleed===v?s.radioItemSelected:{})}}><input type="radio" name="doubleBlockAndBleed" value={v} checked={formData.doubleBlockAndBleed===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div><div style={s.formGroup}><label style={s.label}>Single Block and Bleed?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(v=><label key={v} style={{...s.radioItem,...(formData.singleBlockAndBleed===v?s.radioItemSelected:{})}}><input type="radio" name="singleBlockAndBleed" value={v} checked={formData.singleBlockAndBleed===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div></div>
          <div style={s.formGroup}><label style={s.label}>Line Blinding Required?</label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.lineBlindingRequired===v?s.radioItemSelected:{})}}><input type="radio" name="lineBlindingRequired" value={v} checked={formData.lineBlindingRequired===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div>
          {formData.lineBlindingRequired==='Yes'&&<div style={s.blindDetails}><div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Blind Location</label><input type="text" name="blindLocation" value={formData.blindLocation} onChange={handleChange} placeholder="Describe location..." style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Blind Size</label><input type="text" name="blindSize" value={formData.blindSize} onChange={handleChange} placeholder="e.g., 6 inch" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Blind Rating</label><select name="blindRating" value={formData.blindRating} onChange={handleChange} style={s.select}><option value="">Select...</option>{BLIND_RATINGS.map(r=><option key={r} value={r}>{r}</option>)}</select></div></div><div style={s.checkboxGrid}><div style={{...s.checkboxItem,...(formData.spectacleBlind?s.checkboxItemChecked:{})}} onClick={()=>setFormData(p=>({...p,spectacleBlind:!p.spectacleBlind}))}><input type="checkbox" checked={formData.spectacleBlind} readOnly style={{marginRight:'8px'}}/><span>Spectacle Blind</span></div><div style={{...s.checkboxItem,...(formData.paddleBlind?s.checkboxItemChecked:{})}} onClick={()=>setFormData(p=>({...p,paddleBlind:!p.paddleBlind}))}><input type="checkbox" checked={formData.paddleBlind} readOnly style={{marginRight:'8px'}}/><span>Paddle Blind</span></div><div style={{...s.checkboxItem,...(formData.slipPlate?s.checkboxItemChecked:{})}} onClick={()=>setFormData(p=>({...p,slipPlate:!p.slipPlate}))}><input type="checkbox" checked={formData.slipPlate} readOnly style={{marginRight:'8px'}}/><span>Slip Plate</span></div></div></div>}
          <div style={{...s.formRow,marginTop:'12px'}}><div style={s.formGroup}><label style={s.label}>Line Drained?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(v=><label key={v} style={{...s.radioItem,...(formData.lineDrained===v?s.radioItemSelected:{})}}><input type="radio" name="lineDrained" value={v} checked={formData.lineDrained===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div><div style={s.formGroup}><label style={s.label}>Line Depressurized?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(v=><label key={v} style={{...s.radioItem,...(formData.lineDepressurized===v?s.radioItemSelected:{})}}><input type="radio" name="lineDepressurized" value={v} checked={formData.lineDepressurized===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div><div style={s.formGroup}><label style={s.label}>Line Purged?</label><div style={s.radioGroup}>{['Yes','No','N/A'].map(v=><label key={v} style={{...s.radioItem,...(formData.linePurged===v?s.radioItemSelected:{})}}><input type="radio" name="linePurged" value={v} checked={formData.linePurged===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div></div>
          {formData.linePurged==='Yes'&&<div style={s.formGroup}><label style={s.label}>Purge Method</label><select name="purgeMethod" value={formData.purgeMethod} onChange={handleChange} style={s.select}><option value="">Select...</option>{PURGE_METHODS.map(m=><option key={m} value={m}>{m}</option>)}</select></div>}
        </div></div>
        
        {/* ATMOSPHERIC TESTING */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionCyan}}>üå¨Ô∏è Atmospheric Testing</div><div style={s.sectionBody}>
          <div style={s.formGroup}><label style={s.label}>Atmospheric Testing Required? <span style={s.required}>*</span></label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.atmosphericTestRequired===v?s.radioItemSelected:{})}}><input type="radio" name="atmosphericTestRequired" value={v} checked={formData.atmosphericTestRequired===v} onChange={handleChange} required/><span>{v}</span></label>)}</div></div>
          {formData.atmosphericTestRequired==='Yes'&&<><div style={s.infoBox}>‚ÑπÔ∏è Acceptable Levels: O‚ÇÇ: 19.5-23.5% | LEL: &lt; 10% | H‚ÇÇS: &lt; 10 ppm | Benzene: &lt; 0.5 ppm</div><div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Oxygen (O‚ÇÇ) %</label><input type="text" name="oxygenLevel" value={formData.oxygenLevel} onChange={handleChange} placeholder="19.5-23.5" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>LEL %</label><input type="text" name="lelLevel" value={formData.lelLevel} onChange={handleChange} placeholder="< 10%" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>H‚ÇÇS (ppm)</label><input type="text" name="h2sLevel" value={formData.h2sLevel} onChange={handleChange} placeholder="< 10" style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Benzene (ppm)</label><input type="text" name="benzeneLevel" value={formData.benzeneLevel} onChange={handleChange} placeholder="< 0.5" style={s.input}/></div></div><div style={s.formGroup}><label style={s.label}>Atmospheric Test Pass?</label><div style={s.radioGroup}><label style={{...s.radioItem,...(formData.atmosphericTestPass==='Yes'?s.radioItemSelected:{})}}><input type="radio" name="atmosphericTestPass" value="Yes" checked={formData.atmosphericTestPass==='Yes'} onChange={handleChange}/><span>Yes - All Within Limits</span></label><label style={{...s.radioItem,...(formData.atmosphericTestPass==='No'?s.radioItemSelected:{})}}><input type="radio" name="atmosphericTestPass" value="No" checked={formData.atmosphericTestPass==='No'} onChange={handleChange}/><span>No - Additional Controls Required</span></label></div></div></>}
        </div></div>
        
        {/* REQUIRED PPE */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionGreen}}>ü¶∫ Required PPE</div><div style={s.sectionBody}>
          <div style={s.infoBox}>‚ÑπÔ∏è Select ALL required PPE based on identified hazards. PPE requirements are hazard-driven.</div>
          <div style={s.checkboxGrid}>{PPE_ITEMS.map(p=><div key={p.id} style={{...s.checkboxItem,...(formData.requiredPpe[p.id]?s.checkboxItemChecked:{})}} onClick={()=>handlePpeToggle(p.id)}><input type="checkbox" checked={formData.requiredPpe[p.id]||false} readOnly style={{marginRight:'8px',accentColor:'#059669'}}/><span>{p.label}</span></div>)}</div>
          <div style={{...s.formRow,marginTop:'12px'}}><div style={s.formGroup}><label style={s.label}>Respiratory Protection Required?</label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.respiratoryProtection===v?s.radioItemSelected:{})}}><input type="radio" name="respiratoryProtection" value={v} checked={formData.respiratoryProtection===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div>{formData.respiratoryProtection==='Yes'&&<div style={s.formGroup}><label style={s.label}>Respiratory Type</label><select name="respiratoryType" value={formData.respiratoryType} onChange={handleChange} style={s.select}><option value="">Select...</option>{RESPIRATORY_TYPES.map(t=><option key={t} value={t}>{t}</option>)}</select></div>}</div>
        </div></div>
        
        {/* ADDITIONAL SAFEGUARDS */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionOrange}}>üõ°Ô∏è Additional Safeguards</div><div style={s.sectionBody}>
          <div style={s.checkboxGrid}>{SAFEGUARD_ITEMS.map(sg=><div key={sg.id} style={{...s.checkboxItem,...(formData.safeguards[sg.id]?s.checkboxItemChecked:{})}} onClick={()=>handleSafeguardToggle(sg.id)}><input type="checkbox" checked={formData.safeguards[sg.id]||false} readOnly style={{marginRight:'8px',accentColor:'#ea580c'}}/><span>{sg.label}</span></div>)}</div>
          <div style={{...s.formRow,marginTop:'12px'}}><div style={s.formGroup}><label style={s.label}>Hot Work Permit Required?</label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.hotWorkPermitRequired===v?s.radioItemSelected:{})}}><input type="radio" name="hotWorkPermitRequired" value={v} checked={formData.hotWorkPermitRequired===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div><div style={s.formGroup}><label style={s.label}>Confined Space Entry Required?</label><div style={s.radioGroup}>{['Yes','No'].map(v=><label key={v} style={{...s.radioItem,...(formData.confinedSpaceEntryRequired===v?s.radioItemSelected:{})}}><input type="radio" name="confinedSpaceEntryRequired" value={v} checked={formData.confinedSpaceEntryRequired===v} onChange={handleChange}/><span>{v}</span></label>)}</div></div></div>
        </div></div>
        
        {/* PRE-WORK VERIFICATION */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionAmber}}>‚úîÔ∏è Pre-Work Verification</div><div style={s.sectionBody}>
          <div style={s.warningBox}>‚ö†Ô∏è ALL items must be verified before initiating line break. Stop work if any item cannot be confirmed.</div>
          <div style={s.checkboxGrid}>{VERIFICATION_ITEMS.map(v=><div key={v.id} style={{...s.checkboxItem,...(formData.verification[v.id]?{...s.checkboxItemChecked,borderColor:'#ca8a04',background:'#fef3c7'}:{})}} onClick={()=>handleVerificationToggle(v.id)}><input type="checkbox" checked={formData.verification[v.id]||false} readOnly style={{marginRight:'8px',accentColor:'#ca8a04'}}/><span>{v.label}</span></div>)}</div>
        </div></div>
        
        {/* AUTHORIZATION */}
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionGreen}}>‚úçÔ∏è Authorization</div><div style={s.sectionBody}>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Responsible Operator <span style={s.required}>*</span></label><input type="text" name="responsibleOperator" value={formData.responsibleOperator} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Area Supervisor <span style={s.required}>*</span></label><input type="text" name="areaSupervisor" value={formData.areaSupervisor} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Performing Supervisor <span style={s.required}>*</span></label><input type="text" name="performingSupervisor" value={formData.performingSupervisor} onChange={handleChange} required style={s.input}/></div></div>
          <div style={s.formRow}><div style={s.formGroup}><label style={s.label}>Start Time <span style={s.required}>*</span></label><input type="time" name="startTime" value={formData.startTime} onChange={handleChange} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Expiration Time <span style={s.required}>*</span></label><input type="time" name="expirationTime" value={formData.expirationTime} onChange={handleChange} required style={s.input}/></div></div>
        </div></div>
        
        <button type="submit" disabled={isSubmitting} style={{...s.submitBtn,opacity:isSubmitting?0.5:1}}>{isSubmitting?'Issuing Permit...':'Submit Permit'}</button>
      </form>)}
      
      {/* CLOSE OUT TAB */}
      {activeTab==='closeout'&&<div>{closeoutSuccess?<div style={s.successMessage}><div style={{fontSize:'48px',marginBottom:'15px'}}>‚úÖ</div><h2 style={{margin:'0 0 10px'}}>Permit Closed Successfully!</h2><p>System has been returned to safe operating condition.</p><button onClick={resetCloseout} style={{...s.submitBtn,maxWidth:'250px',background:'white',color:'#059669',marginTop:'15px'}}>Close Another Permit</button></div>:<>
        <div style={s.section}><div style={{...s.sectionHeader,...s.sectionGreen}}>üîç Select Permit to Close Out</div><div style={s.sectionBody}>
          {openPermits.length===0?<p style={{textAlign:'center',color:'#6b7280'}}>No open permits found.</p>:openPermits.map(p=><div key={p.permit_number} style={{...s.permitCard,...(selectedPermit===p.permit_number?s.permitCardSelected:{})}} onClick={()=>setSelectedPermit(p.permit_number)}><div style={{fontWeight:'700',color:'#1e3a8a',fontSize:'14px'}}>{p.permit_number}</div><div style={{fontSize:'13px',color:'#6b7280',marginTop:'4px'}}>{p.location} | {p.line_equipment_id} | {p.opening_type}</div></div>)}
        </div></div>
        
        {selectedPermit&&<div style={s.section}><div style={{...s.sectionHeader,...s.sectionRed}}>‚úÖ Close Out Checklist</div><div style={s.sectionBody}>
          <div style={s.warningBox}>‚ö†Ô∏è Verify all items before closing the permit. System must be returned to safe operating condition.</div>
          <div style={s.infoBox}><strong>Closing Permit:</strong> {selectedPermit}</div>
          {[{id:'lineRestored',label:'Line/Equipment Restored'},{id:'blindsRemoved',label:'Blinds Removed (if applicable)'},{id:'systemPressureTested',label:'System Pressure Tested'},{id:'leakCheckPerformed',label:'Leak Check Performed'}].map(v=><div key={v.id} style={{...s.verificationItem,...(closeoutData[v.id]?s.verificationItemChecked:{})}} onClick={()=>setCloseoutData(p=>({...p,[v.id]:!p[v.id]}))}><input type="checkbox" checked={closeoutData[v.id]} readOnly style={{marginRight:'10px',width:'18px',height:'18px',accentColor:'#059669'}}/><span style={{fontSize:'13px'}}>{v.label}</span></div>)}
          <div style={{...s.formRow,marginTop:'12px'}}><div style={s.formGroup}><label style={s.label}>Time Permit Closed <span style={s.required}>*</span></label><input type="time" value={closeoutData.timePermitClosed} onChange={e=>setCloseoutData(p=>({...p,timePermitClosed:e.target.value}))} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Close Out Operator <span style={s.required}>*</span></label><input type="text" value={closeoutData.closeOutOperator} onChange={e=>setCloseoutData(p=>({...p,closeOutOperator:e.target.value}))} required style={s.input}/></div><div style={s.formGroup}><label style={s.label}>Close Out Supervisor <span style={s.required}>*</span></label><input type="text" value={closeoutData.closeOutSupervisor} onChange={e=>setCloseoutData(p=>({...p,closeOutSupervisor:e.target.value}))} required style={s.input}/></div></div>
          <button type="button" onClick={submitCloseout} disabled={isSubmitting} style={{...s.submitBtn,...s.submitBtnGreen,opacity:isSubmitting?0.5:1}}>{isSubmitting?'Closing...':'Close Out Permit'}</button>
        </div></div>}
      </>}</div>}
    </div>
    
    <div style={{textAlign:'center',padding:'20px',background:'linear-gradient(to bottom, #f8fafc, #ffffff)',color:'#64748b',fontSize:'11px',borderTop:'1px solid #e2e8f0'}}><span style={{color:'#1e3a5f',fontWeight:'500'}}>Powered by Predictive Safety Analytics‚Ñ¢</span><span style={{color:'#94a3b8',margin:'0 8px'}}>|</span><span style={{color:'#475569'}}>¬© 2025 SLP Alaska</span></div>
  </div></div>);
}
